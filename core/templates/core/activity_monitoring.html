{% extends 'core/base.html' %}

{% block title %}Мониторинг активности - Астрокоины{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="fas fa-chart-line me-2"></i>
                Мониторинг активности учеников
                {% if is_superuser %}
                    <span class="badge bg-danger ms-2">Администратор</span>
                {% else %}
                    <span class="badge bg-primary ms-2">Учитель</span>
                {% endif %}
            </h2>
            <p class="text-muted">
                {% if is_superuser %}
                    Вы видите активность всех учеников в системе
                {% else %}
                    Вы видите активность только учеников вашей группы
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Навигационные вкладки -->
    <ul class="nav nav-tabs mb-4" id="activityTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="purchases-tab" data-bs-toggle="tab" data-bs-target="#purchases" type="button" role="tab">
                <i class="fas fa-shopping-cart me-2"></i>Покупки ({{ purchases.paginator.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="transfers-tab" data-bs-toggle="tab" data-bs-target="#transfers" type="button" role="tab">
                <i class="fas fa-exchange-alt me-2"></i>Переводы ({{ transfers.paginator.count }})
            </button>
        </li>
    </ul>

    <!-- Содержимое вкладок -->
    <div class="tab-content" id="activityTabsContent">
        <!-- Вкладка покупок -->
        <div class="tab-pane fade show active" id="purchases" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>История покупок
                    </h5>
                </div>
                <div class="card-body">
                    {% if purchases %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>№</th>
                                        <th>Пользователь</th>
                                        <th>Группа</th>
                                        <th>Товар</th>
                                        <th>Сумма</th>
                                        <th>Дата</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for purchase in purchases %}
                                    <tr>
                                        <td>{{ forloop.counter0|add:purchases.start_index }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-circle me-2 text-primary"></i>
                                                <div>
                                                    <strong>{{ purchase.user.get_full_name|default:purchase.user.username }}</strong>
                                                    <br>
                                                    <small class="text-muted">@{{ purchase.user.username }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if purchase.user.group %}
                                                <span class="badge bg-info">{{ purchase.user.group.name }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Без группы</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if purchase.product.icon %}
                                                    <i class="{{ purchase.product.icon }} me-2 text-warning"></i>
                                                {% else %}
                                                    <i class="fas fa-box me-2 text-warning"></i>
                                                {% endif %}
                                                {{ purchase.product.name }}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">
                                                <i class="fas fa-coins me-1"></i>{{ purchase.product.price }} AC
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                <i class="far fa-clock me-1"></i>
                                                {{ purchase.created_at|date:"d.m.Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Пагинация для покупок -->
                        {% if purchases.has_other_pages %}
                            <nav aria-label="Пагинация покупок">
                                <ul class="pagination justify-content-center">
                                    {% if purchases.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?purchases_page=1#purchases">Первая</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?purchases_page={{ purchases.previous_page_number }}#purchases">Предыдущая</a>
                                        </li>
                                    {% endif %}
                                    
                                    <li class="page-item active">
                                        <span class="page-link">{{ purchases.number }} из {{ purchases.paginator.num_pages }}</span>
                                    </li>
                                    
                                    {% if purchases.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?purchases_page={{ purchases.next_page_number }}#purchases">Следующая</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?purchases_page={{ purchases.paginator.num_pages }}#purchases">Последняя</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Покупок пока нет</h5>
                            <p class="text-muted">Ученики ещё не совершали покупки в магазине</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Вкладка переводов -->
        <div class="tab-pane fade" id="transfers" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exchange-alt me-2"></i>История переводов
                    </h5>
                </div>
                <div class="card-body">
                    {% if transfers %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>№</th>
                                        <th>Отправитель</th>
                                        <th>Получатель</th>
                                        <th>Сумма</th>
                                        <th>Дата</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transfer in transfers %}
                                    <tr>
                                        <td>{{ forloop.counter0|add:transfers.start_index }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-circle me-2 text-danger"></i>
                                                <div>
                                                    <strong>{{ transfer.sender.get_full_name|default:transfer.sender.username }}</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        @{{ transfer.sender.username }}
                                                        {% if transfer.sender.group %}
                                                            • {{ transfer.sender.group.name }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user-circle me-2 text-success"></i>
                                                <div>
                                                    <strong>{{ transfer.receiver.get_full_name|default:transfer.receiver.username }}</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        @{{ transfer.receiver.username }}
                                                        {% if transfer.receiver.group %}
                                                            • {{ transfer.receiver.group.name }}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">
                                                <i class="fas fa-coins me-1"></i>{{ transfer.amount }} AC
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                <i class="far fa-clock me-1"></i>
                                                {{ transfer.created_at|date:"d.m.Y H:i" }}
                                            </small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Пагинация для переводов -->
                        {% if transfers.has_other_pages %}
                            <nav aria-label="Пагинация переводов">
                                <ul class="pagination justify-content-center">
                                    {% if transfers.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?transfers_page=1#transfers">Первая</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?transfers_page={{ transfers.previous_page_number }}#transfers">Предыдущая</a>
                                        </li>
                                    {% endif %}
                                    
                                    <li class="page-item active">
                                        <span class="page-link">{{ transfers.number }} из {{ transfers.paginator.num_pages }}</span>
                                    </li>
                                    
                                    {% if transfers.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?transfers_page={{ transfers.next_page_number }}#transfers">Следующая</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?transfers_page={{ transfers.paginator.num_pages }}#transfers">Последняя</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Переводов пока нет</h5>
                            <p class="text-muted">Ученики ещё не совершали переводы между собой</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Улучшения для таблиц */
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    vertical-align: middle;
}

.table-responsive {
    border-radius: 0.375rem;
}

/* Стили для вкладок */
.nav-tabs .nav-link {
    border: none;
    border-radius: 0.5rem 0.5rem 0 0;
    margin-right: 0.25rem;
}

.nav-tabs .nav-link.active {
    background-color: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

/* Адаптивность */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .d-flex.align-items-center div {
        min-width: 0;
    }
    
    .badge {
        font-size: 0.75rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Активация правильной вкладки при переходе по хэшу
    const hash = window.location.hash;
    if (hash === '#transfers') {
        const transfersTab = new bootstrap.Tab(document.getElementById('transfers-tab'));
        transfersTab.show();
    }
    
    // Обновление URL при переключении вкладок
    const tabs = document.querySelectorAll('#activityTabs button[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('data-bs-target');
            history.replaceState(null, null, target);
        });
    });
});
</script>
{% endblock %}