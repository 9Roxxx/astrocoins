{% extends "core/base.html" %}
{% load i18n %}

{% block title %}–ú–æ–∏ –≥—Ä—É–ø–ø—ã - AstroCoins{% endblock %}

{% block content %}
<div class="container">
    {% if user.is_teacher %}
    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>–ú–æ–∏ –≥—Ä—É–ø–ø—ã
                    </h5>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                    </button>
                </div>
                <div class="card-body">
                    {% if groups %}
                        <div class="row">
                            {% for group in groups %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 {% if not group.is_active %}border-warning{% endif %}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">
                                                {% if group.is_active %}
                                                <span class="badge bg-success me-2">üü¢</span>
                                                {% else %}
                                                <span class="badge bg-warning me-2">‚è∏Ô∏è</span>
                                                {% endif %}
                                                {{ group.name }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-users me-1"></i>{{ group.students_count }} —É—á–µ–Ω–∏–∫–æ–≤
                                            </small>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        {% if group.description %}
                                        <p class="card-text">{{ group.description }}</p>
                                        {% endif %}
                                        
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <small class="text-muted">–ö—É—Ä—Å:</small>
                                                <br><strong>{{ group.course.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">–®–∫–æ–ª–∞:</small>
                                                <br><strong>{{ group.school.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</strong>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            {% if group.first_lesson_date %}
                                            <div class="col-6">
                                                <small class="text-muted">–ü–µ—Ä–≤—ã–π —É—Ä–æ–∫:</small>
                                                <br><strong>{{ group.first_lesson_date|date:"d.m.Y" }}</strong>
                                            </div>
                                            {% endif %}
                                            {% if group.lesson_time %}
                                            <div class="col-6">
                                                <small class="text-muted">–í—Ä–µ–º—è:</small>
                                                <br><strong>{{ group.lesson_time|time:"H:i" }}</strong>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if group.classroom %}
                                        <div class="mb-2">
                                            <small class="text-muted">–ö–∞–±–∏–Ω–µ—Ç:</small>
                                            <strong>{{ group.classroom }}</strong>
                                        </div>
                                        {% endif %}
                                        
                                        {% if group.curator %}
                                        <div class="mb-2">
                                            <small class="text-muted">–ö—É—Ä–∞—Ç–æ—Ä:</small>
                                            <strong>{{ group.curator.get_full_name|default:group.curator.username }}</strong>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer">
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="viewGroupStudents({{ group.id }})"
                                                    data-bs-toggle="modal" data-bs-target="#studentsModal">
                                                <i class="fas fa-users me-1"></i>–£—á–µ–Ω–∏–∫–∏
                                            </button>
                                            <button class="btn btn-outline-success btn-sm"
                                                    onclick="showAwardGroupModal({{ group.id }}, '{{ group.name }}')"
                                                    data-bs-toggle="modal" data-bs-target="#awardGroupModal">
                                                <i class="fas fa-coins me-1"></i>–ù–∞—á–∏—Å–ª–∏—Ç—å
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                                <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_group">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groupName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="groupName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="groupSchool" class="form-label">–®–∫–æ–ª–∞ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="groupSchool" name="school" required onchange="loadCourses(this.value)">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>
                                        {% for school in schools %}
                                        <option value="{{ school.id }}">{{ school.name }} ({{ school.city.name }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="groupCourse" class="form-label">–ö—É—Ä—Å <span class="text-danger">*</span></label>
                                    <select class="form-select" id="groupCourse" name="course" required>
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="groupCurator" class="form-label">–ö—É—Ä–∞—Ç–æ—Ä</label>
                                    <select class="form-select" id="groupCurator" name="curator">
                                        <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                                        {% for admin in group_form.curator.field.queryset %}
                                        <option value="{{ admin.id }}">{{ admin.get_full_name|default:admin.username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groupFirstLesson" class="form-label">–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∫–∞</label>
                                    <input type="date" class="form-control" id="groupFirstLesson" name="first_lesson_date">
                                </div>
                                <div class="mb-3">
                                    <label for="groupTime" class="form-label">–í—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏–π</label>
                                    <input type="time" class="form-control" id="groupTime" name="lesson_time">
                                </div>
                                <div class="mb-3">
                                    <label for="groupClassroom" class="form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
                                    <input type="text" class="form-control" id="groupClassroom" name="classroom" 
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 201, –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª–∞—Å—Å">
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="groupActive" name="is_active" checked>
                                    <label class="form-check-label" for="groupActive">
                                        –ê–∫—Ç–∏–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="groupDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="groupDescription" name="description" rows="3" 
                                      placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div class="modal fade" id="studentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–£—á–µ–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="studentsContent">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–µ -->
    <div class="modal fade" id="awardGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ù–∞—á–∏—Å–ª–∏—Ç—å –∞—Å—Ç—Ä–æ–∫–æ–∏–Ω—ã –≥—Ä—É–ø–ø–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="award_group">
                    <input type="hidden" id="awardGroupId" name="group_id">
                    <div class="modal-body">
                        <p>–ì—Ä—É–ø–ø–∞: <strong id="awardGroupName"></strong></p>
                        <div class="mb-3">
                            <label for="awardReason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</label>
                            <select class="form-select" id="awardReason" name="reason_id" required>
                                {% for reason in award_reasons %}
                                <option value="{{ reason.id }}">{{ reason.name }} ({{ reason.coins }} AC)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="awardComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea class="form-control" id="awardComment" name="comment" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-success">–ù–∞—á–∏—Å–ª–∏—Ç—å –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% else %}
    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">–ú–æ—è –≥—Ä—É–ø–ø–∞</h5>
                </div>
                <div class="card-body">
                    {% if group %}
                        <h6>{{ group.name }}</h6>
                        {% if group.description %}
                        <p>{{ group.description }}</p>
                        {% endif %}
                        
                        <div class="row mb-3">
                            {% if group.course %}
                            <div class="col-md-6">
                                <strong>–ö—É—Ä—Å:</strong> {{ group.course.name }}
                            </div>
                            {% endif %}
                            {% if group.school %}
                            <div class="col-md-6">
                                <strong>–®–∫–æ–ª–∞:</strong> {{ group.school.name }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> {{ group.teacher.get_full_name|default:group.teacher.username }}
                            </div>
                            {% if group.curator %}
                            <div class="col-md-6">
                                <strong>–ö—É—Ä–∞—Ç–æ—Ä:</strong> {{ group.curator.get_full_name|default:group.curator.username }}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if group.first_lesson_date or group.lesson_time or group.classroom %}
                        <div class="row mb-3">
                            {% if group.first_lesson_date %}
                            <div class="col-md-4">
                                <strong>–ü–µ—Ä–≤—ã–π —É—Ä–æ–∫:</strong> {{ group.first_lesson_date|date:"d.m.Y" }}
                            </div>
                            {% endif %}
                            {% if group.lesson_time %}
                            <div class="col-md-4">
                                <strong>–í—Ä–µ–º—è:</strong> {{ group.lesson_time|time:"H:i" }}
                            </div>
                            {% endif %}
                            {% if group.classroom %}
                            <div class="col-md-4">
                                <strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> {{ group.classroom }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if classmates %}
                        <h6>–û–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∏:</h6>
                        <div class="list-group">
                            {% for classmate in classmates %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">{{ classmate.get_full_name|default:classmate.username }}</h6>
                                    <small class="text-muted">{{ classmate.profile.astrocoins }} AC</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">–í—ã –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤ –ø–æ —à–∫–æ–ª–µ
function loadCourses(schoolId) {
    const courseSelect = document.getElementById('groupCourse');
    courseSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    
    if (!schoolId) {
        courseSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>';
        return;
    }
    
    fetch(`/api/school/${schoolId}/courses/`)
        .then(response => response.json())
        .then(data => {
            if (data.courses) {
                courseSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>';
                data.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
            } else {
                courseSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</option>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:', error);
            courseSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–µ–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
function viewGroupStudents(groupId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤
    document.getElementById('studentsContent').innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...</p>';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–µ
function showAwardGroupModal(groupId, groupName) {
    document.getElementById('awardGroupId').value = groupId;
    document.getElementById('awardGroupName').textContent = groupName;
}
</script>
{% endblock %}