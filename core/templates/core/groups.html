{% extends "core/base.html" %}
{% load i18n %}

{% block title %}–ú–æ–∏ –≥—Ä—É–ø–ø—ã - AstroCoins{% endblock %}

{% block content %}
<div class="container">
    {% if is_teacher %}
    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>–ú–æ–∏ –≥—Ä—É–ø–ø—ã
                    </h5>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                    </button>
                </div>
                <div class="card-body">
                    {% if groups %}
                        <div class="row">
                            {% for group in groups %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 {% if not group.is_active %}border-warning{% endif %}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">
                                                {% if group.is_active %}
                                                <span class="badge bg-success me-2">üü¢</span>
                                                {% else %}
                                                <span class="badge bg-warning me-2">‚è∏Ô∏è</span>
                                                {% endif %}
                                                {{ group.name }}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-users me-1"></i>{{ group.students_count }} —É—á–µ–Ω–∏–∫–æ–≤
                                            </small>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        {% if group.description %}
                                        <p class="card-text">{{ group.description }}</p>
                                        {% endif %}
                                        
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <small class="text-muted">–ö—É—Ä—Å:</small>
                                                <br><strong>{{ group.course.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">–®–∫–æ–ª–∞:</small>
                                                <br><strong>{{ group.school.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</strong>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            {% if group.first_lesson_date %}
                                            <div class="col-6">
                                                <small class="text-muted">–ü–µ—Ä–≤—ã–π —É—Ä–æ–∫:</small>
                                                <br><strong>{{ group.first_lesson_date|date:"d.m.Y" }}</strong>
                                            </div>
                                            {% endif %}
                                            {% if group.lesson_time %}
                                            <div class="col-6">
                                                <small class="text-muted">–í—Ä–µ–º—è:</small>
                                                <br><strong>{{ group.lesson_time|time:"H:i" }}</strong>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        {% if group.classroom %}
                                        <div class="mb-2">
                                            <small class="text-muted">–ö–∞–±–∏–Ω–µ—Ç:</small>
                                            <strong>{{ group.classroom }}</strong>
                                        </div>
                                        {% endif %}
                                        
                                        {% if group.curator %}
                                        <div class="mb-2">
                                            <small class="text-muted">–ö—É—Ä–∞—Ç–æ—Ä:</small>
                                            <strong>{{ group.curator.get_full_name|default:group.curator.username }}</strong>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer">
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="viewGroupStudents({{ group.id }})"
                                                    data-bs-toggle="modal" data-bs-target="#studentsModal">
                                                <i class="fas fa-users me-1"></i>–£—á–µ–Ω–∏–∫–∏
                                            </button>
                                            {% if is_superuser %}
                                            <button class="btn btn-outline-info btn-sm"
                                                    onclick="showManageStudentsModal({{ group.id }}, '{{ group.name }}')"
                                                    data-bs-toggle="modal" data-bs-target="#manageStudentsModal"
                                                    title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏ –≤ –≥—Ä—É–ø–ø–µ">
                                                <i class="fas fa-user-cog me-1"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-outline-success btn-sm"
                                                    onclick="showAwardGroupModal({{ group.id }}, '{{ group.name }}')"
                                                    data-bs-toggle="modal" data-bs-target="#awardGroupModal">
                                                <i class="fas fa-coins me-1"></i>–ù–∞—á–∏—Å–ª–∏—Ç—å
                                            </button>
                                            {% if is_superuser %}
                                            <button class="btn btn-outline-danger btn-sm"
                                                    onclick="showDeleteGroupModal({{ group.id }}, '{{ group.name }}')"
                                                    data-bs-toggle="modal" data-bs-target="#deleteGroupModal"
                                                    title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                                <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create_group">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groupName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="groupName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="groupSchool" class="form-label">–®–∫–æ–ª–∞ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="groupSchool" name="school" required onchange="loadCourses(this.value)">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>
                                        {% for school in schools %}
                                        <option value="{{ school.id }}">{{ school.name }} ({{ school.city.name }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="groupCourse" class="form-label">–ö—É—Ä—Å <span class="text-danger">*</span></label>
                                    <select class="form-select" id="groupCourse" name="course" required>
                                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="groupTeacher" class="form-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å <span class="text-danger">*</span></label>
                                    <select class="form-select" id="groupTeacher" name="teacher" required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
                                        {% for teacher in group_form.teacher.field.queryset %}
                                        <option value="{{ teacher.id }}">{{ teacher.get_full_name|default:teacher.username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="groupCurator" class="form-label">–ö—É—Ä–∞—Ç–æ—Ä</label>
                                    <select class="form-select" id="groupCurator" name="curator">
                                        <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                                        {% for admin in group_form.curator.field.queryset %}
                                        <option value="{{ admin.id }}">{{ admin.get_full_name|default:admin.username }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groupFirstLesson" class="form-label">–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∫–∞</label>
                                    <input type="date" class="form-control" id="groupFirstLesson" name="first_lesson_date">
                                </div>
                                <div class="mb-3">
                                    <label for="groupTime" class="form-label">–í—Ä–µ–º—è –∑–∞–Ω—è—Ç–∏–π</label>
                                    <input type="time" class="form-control" id="groupTime" name="lesson_time">
                                </div>
                                <div class="mb-3">
                                    <label for="groupClassroom" class="form-label">–ö–∞–±–∏–Ω–µ—Ç</label>
                                    <input type="text" class="form-control" id="groupClassroom" name="classroom" 
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 201, –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –∫–ª–∞—Å—Å">
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="groupActive" name="is_active" checked>
                                    <label class="form-check-label" for="groupActive">
                                        –ê–∫—Ç–∏–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="groupDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="groupDescription" name="description" rows="3" 
                                      placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–µ–Ω–∏–∫–æ–≤ -->
    <div class="modal fade" id="studentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–£—á–µ–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="studentsContent">
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–µ -->
    <div class="modal fade" id="awardGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ù–∞—á–∏—Å–ª–∏—Ç—å –∞—Å—Ç—Ä–æ–∫–æ–∏–Ω—ã –≥—Ä—É–ø–ø–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="award_group">
                    <input type="hidden" id="awardGroupId" name="group_id">
                    <div class="modal-body">
                        <p>–ì—Ä—É–ø–ø–∞: <strong id="awardGroupName"></strong></p>
                        <div class="mb-3">
                            <label for="awardReason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</label>
                            <select class="form-select" id="awardReason" name="reason_id" required>
                                {% for reason in award_reasons %}
                                <option value="{{ reason.id }}">{{ reason.name }} ({{ reason.coins }} AC)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="awardComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea class="form-control" id="awardComment" name="comment" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-success">–ù–∞—á–∏—Å–ª–∏—Ç—å –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal fade" id="deleteGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" action="{% url 'user_management' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_group">
                    <input type="hidden" id="deleteGroupId" name="group_id">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.
                        </div>
                        <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É <strong id="deleteGroupName"></strong>?</p>
                        <p class="text-muted">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                –í—Å–µ —É—á–µ–Ω–∏–∫–∏ –±—É–¥—É—Ç –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω—ã –æ—Ç –≥—Ä—É–ø–ø—ã, –Ω–æ –∏—Ö –∞–∫–∫–∞—É–Ω—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.
                            </small>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–º—É —É—á–µ–Ω–∏–∫—É -->
    <div class="modal fade" id="awardStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ù–∞—á–∏—Å–ª–∏—Ç—å –∞—Å—Ç—Ä–æ–∫–æ–∏–Ω—ã —É—á–µ–Ω–∏–∫—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="award_student">
                    <input type="hidden" id="awardStudentId" name="student_id">
                    <div class="modal-body">
                        <p>–£—á–µ–Ω–∏–∫: <strong id="awardStudentName"></strong></p>
                        <div class="mb-3">
                            <label for="awardStudentReason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</label>
                            <select class="form-select" id="awardStudentReason" name="reason_id" required>
                                {% for reason in award_reasons %}
                                <option value="{{ reason.id }}">{{ reason.name }} ({{ reason.coins }} AC)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="awardStudentComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                            <textarea class="form-control" id="awardStudentComment" name="comment" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-success">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞–º–∏ –≤ –≥—Ä—É–ø–ø–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤) -->
    {% if is_superuser %}
    <div class="modal fade" id="manageStudentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-cog me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏ - 
                        <span id="manageGroupName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–æ–≤ -->
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-user-plus text-success me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–æ–≤
                            </h6>
                            {% if students_without_group %}
                            <div class="mb-3">
                                <small class="text-muted">–£—á–µ–Ω–∏–∫–∏ –±–µ–∑ –≥—Ä—É–ø–ø—ã:</small>
                                <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                                    {% for student in students_without_group %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ student.get_full_name|default:student.username }}</strong>
                                            <br><small class="text-muted">@{{ student.username }}</small>
                                        </div>
                                        <form method="post" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="add_student_to_group">
                                            <input type="hidden" name="student_id" value="{{ student.id }}">
                                            <input type="hidden" name="group_id" id="addToGroupId">
                                            <button type="submit" class="btn btn-sm btn-success" 
                                                    title="–î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>–í—Å–µ —É—á–µ–Ω–∏–∫–∏ —É–∂–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –≥—Ä—É–ø–ø–∞–º
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£—á–µ–Ω–∏–∫–∏ –≤ –≥—Ä—É–ø–ø–µ -->
                        <div class="col-md-6">
                            <h6 class="mb-3">
                                <i class="fas fa-users text-primary me-2"></i>–£—á–µ–Ω–∏–∫–∏ –≤ –≥—Ä—É–ø–ø–µ
                            </h6>
                            <div id="groupStudentsList">
                                <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">–ú–æ—è –≥—Ä—É–ø–ø–∞</h5>
                </div>
                <div class="card-body">
                    {% if group %}
                        <h6>{{ group.name }}</h6>
                        {% if group.description %}
                        <p>{{ group.description }}</p>
                        {% endif %}
                        
                        <div class="row mb-3">
                            {% if group.course %}
                            <div class="col-md-6">
                                <strong>–ö—É—Ä—Å:</strong> {{ group.course.name }}
                            </div>
                            {% endif %}
                            {% if group.school %}
                            <div class="col-md-6">
                                <strong>–®–∫–æ–ª–∞:</strong> {{ group.school.name }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:</strong> {{ group.teacher.get_full_name|default:group.teacher.username }}
                            </div>
                            {% if group.curator %}
                            <div class="col-md-6">
                                <strong>–ö—É—Ä–∞—Ç–æ—Ä:</strong> {{ group.curator.get_full_name|default:group.curator.username }}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if group.first_lesson_date or group.lesson_time or group.classroom %}
                        <div class="row mb-3">
                            {% if group.first_lesson_date %}
                            <div class="col-md-4">
                                <strong>–ü–µ—Ä–≤—ã–π —É—Ä–æ–∫:</strong> {{ group.first_lesson_date|date:"d.m.Y" }}
                            </div>
                            {% endif %}
                            {% if group.lesson_time %}
                            <div class="col-md-4">
                                <strong>–í—Ä–µ–º—è:</strong> {{ group.lesson_time|time:"H:i" }}
                            </div>
                            {% endif %}
                            {% if group.classroom %}
                            <div class="col-md-4">
                                <strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> {{ group.classroom }}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if classmates %}
                        <h6>–û–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∏:</h6>
                        <div class="list-group">
                            {% for classmate in classmates %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">{{ classmate.get_full_name|default:classmate.username }}</h6>
                                    <small class="text-muted">{{ classmate.profile.astrocoins }} AC</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">–í—ã –ø–æ–∫–∞ –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤ –ø–æ —à–∫–æ–ª–µ
function loadCourses(schoolId) {
    const courseSelect = document.getElementById('groupCourse');
    courseSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    
    if (!schoolId) {
        courseSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>';
        return;
    }
    
    fetch(`/api/school/${schoolId}/courses/`)
        .then(response => response.json())
        .then(data => {
            if (data.courses) {
                courseSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>';
                data.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    courseSelect.appendChild(option);
                });
            } else {
                courseSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</option>';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤:', error);
            courseSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–µ–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
function viewGroupStudents(groupId) {
    const studentsContent = document.getElementById('studentsContent');
    studentsContent.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...</div>';
    
    fetch(`/api/group/${groupId}/students/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                studentsContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            let html = `<h6 class="mb-3">–ì—Ä—É–ø–ø–∞: ${data.group_name}</h6>`;
            
            if (data.students && data.students.length > 0) {
                html += `<p class="text-muted mb-3">–í—Å–µ–≥–æ —É—á–µ–Ω–∏–∫–æ–≤: ${data.total_students}</p>`;
                html += '<div class="list-group">';
                
                data.students.forEach(student => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${student.full_name}</h6>
                                <small class="text-muted">@${student.username}</small>
                                ${student.email ? `<br><small class="text-muted">${student.email}</small>` : ''}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning text-dark mb-1">
                                    <i class="fas fa-coins me-1"></i>${student.astrocoins} AC
                                </span>
                                <br>
                                <small class="text-muted">–° ${student.date_joined}</small>
                                <br>
                                <button class="btn btn-sm btn-success mt-1" 
                                        onclick="showAwardStudentModal(${student.id}, '${student.full_name}')"
                                        data-bs-toggle="modal" data-bs-target="#awardStudentModal">
                                    <i class="fas fa-plus me-1"></i>–ù–∞—á–∏—Å–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="alert alert-info">–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.</div>';
            }
            
            studentsContent.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤:', error);
            studentsContent.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–µ–Ω–∏–∫–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
        });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–µ
function showAwardGroupModal(groupId, groupName) {
    document.getElementById('awardGroupId').value = groupId;
    document.getElementById('awardGroupName').textContent = groupName;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–º—É —É—á–µ–Ω–∏–∫—É
function showAwardStudentModal(studentId, studentName) {
    document.getElementById('awardStudentId').value = studentId;
    document.getElementById('awardStudentName').textContent = studentName;
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —É—á–µ–Ω–∏–∫–∞–º–∏ —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
    const studentsModal = bootstrap.Modal.getInstance(document.getElementById('studentsModal'));
    if (studentsModal) {
        studentsModal.hide();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
function showDeleteGroupModal(groupId, groupName) {
    document.getElementById('deleteGroupId').value = groupId;
    document.getElementById('deleteGroupName').textContent = groupName;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞–º–∏
function showManageStudentsModal(groupId, groupName) {
    document.getElementById('manageGroupName').textContent = groupName;
    document.getElementById('addToGroupId').value = groupId;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–µ
    loadGroupStudentsForManagement(groupId);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function loadGroupStudentsForManagement(groupId) {
    const studentsList = document.getElementById('groupStudentsList');
    studentsList.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    fetch(`/api/group/${groupId}/students/`)
        .then(response => response.json())
        .then(data => {
            let html = '';
            
            if (data.students && data.students.length > 0) {
                html += '<div class="list-group" style="max-height: 300px; overflow-y: auto;">';
                
                data.students.forEach(student => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${student.full_name}</strong>
                                <br><small class="text-muted">@${student.username}</small>
                            </div>
                            <form method="post" style="display: inline;">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                <input type="hidden" name="action" value="remove_student_from_group">
                                <input type="hidden" name="student_id" value="${student.id}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                        title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã"
                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ ${student.full_name} –∏–∑ –≥—Ä—É–ø–ø—ã?')">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </form>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>–í –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</div>';
            }
            
            studentsList.innerHTML = html;
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤:', error);
            studentsList.innerHTML = '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—á–µ–Ω–∏–∫–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
        });
}
</script>
{% endblock %}